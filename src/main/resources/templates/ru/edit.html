<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Редактирование пользователя</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div class="container">
    <header class="header" role="banner" aria-labelledby="edit-title">
        <h2 id="edit-title" class="page-title">Редактировать: <span th:text="${userDto.username}"
                                                                    class="muted">username</span></h2>
        <a th:href="@{/admin}" class="btn btn-ghost" role="button" aria-label="Back to users">← Назад</a>
    </header>

    <main role="main">
        <section class="card" aria-labelledby="basic-info">
            <h3 id="basic-info">Основная информация</h3>

            <form th:action="@{'/admin/edit/' + ${userDto.username}}" th:object="${userDto}" method="post" novalidate>
                <div class="form-group">
                    <label for="username">Username</label>
                    <input id="username" th:field="*{username}" type="text" required autocomplete="username"
                           aria-required="true">
                </div>

                <div class="form-group">
                    <label for="role">Role</label>
                    <select id="role" th:field="*{role}" class="role-select" required aria-required="true">
                        <option th:each="r : ${allRoles}" th:value="${r}" th:text="${r}"
                                th:selected="${r == userDto.role}">ROLE
                        </option>
                    </select>
                </div>

                <div style="margin-top:.5rem">
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </section>

        <section class="card" style="margin-top:1rem" aria-labelledby="scopes-manage">
            <h3 id="scopes-manage">Управление правами (Scopes)</h3>

            <form id="scopesForm" th:action="@{'/admin/edit/' + ${userDto.username} + '/updateScopes'}" method="post"
                  onsubmit="return prepareScopes(this)">
                <div class="dual-list" role="application" aria-label="Scope picker">
                    <div>
                        <label class="small" for="available">Доступные</label>
                        <div id="available" class="multi-select" tabindex="0" aria-live="polite">
                            <div th:each="s : ${allScopes}" th:if="${!userScopes.contains(s)}"
                                 class="badge-item" th:attr="data-value=${s}" th:text="${s}">
                            </div>
                        </div>
                    </div>

                    <div class="dual-actions center" aria-hidden="false">
                        <button type="button" class="btn btn-ghost" onclick="moveSelected('available','assigned')"
                                aria-label="Assign selected">→
                        </button>
                        <button type="button" class="btn btn-ghost" onclick="moveSelected('assigned','available')"
                                aria-label="Unassign selected">←
                        </button>
                    </div>

                    <div>
                        <label class="small" for="assigned">Назначенные</label>
                        <div id="assigned" class="multi-select" tabindex="0" aria-live="polite">
                            <div th:each="s : ${userScopes}"
                                 class="badge-item" th:attr="data-value=${s}" th:text="${s}">
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top:1rem">
                    <button type="submit" class="btn btn-primary">Обновить права</button>
                    <a th:href="@{/admin}" class="btn btn-ghost" style="margin-left:.5rem">Отмена</a>
                </div>
            </form>
        </section>
    </main>
</div>

<script>
    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('badge-item')) {
            e.target.classList.toggle('selected');
        }
    });

    function moveSelected(fromId, toId) {
        const from = document.getElementById(fromId);
        const to = document.getElementById(toId);
        const selected = from.querySelectorAll('.badge-item.selected');
        selected.forEach(el => {
            el.classList.remove('selected');
            to.appendChild(el);
        });
    }

    function prepareScopes(form) {
        form.querySelectorAll('input[name="scopes"]').forEach(el => el.remove());

        const assigned = document.getElementById('assigned').querySelectorAll('.badge-item');
        assigned.forEach(el => {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'scopes';
            hiddenInput.value = el.dataset.value;
            form.appendChild(hiddenInput);
        });

        return true;
    }
</script>
</body>
</html>
