<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div class="container">
    <header class="header-section" role="banner" aria-labelledby="account-title">
        <div>
            <h1 id="account-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</h1>
            <p class="small muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π</p>
        </div>

        <nav class="admin-nav" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞">
            <a th:if="${userDto.getScopes().contains('CHANGE_ROLES') || userDto.getRole().equals('ADMIN')}"
               th:href="@{/admin/roles}" class="btn btn-ghost" role="button">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏</a>
            <a th:if="${userDto.getScopes().contains('CHANGE_SCOPES') || userDto.getRole().equals('ADMIN')}"
               th:href="@{/admin/scopes}" class="btn btn-ghost" role="button">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏</a>
            <a th:if="${userDto.getScopes().contains('CHANGE_USERS') || userDto.getRole().equals('ADMIN')}"
               th:href="@{/admin}" class="btn btn-ghost" role="button">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</a>
        </nav>
    </header>

    <main class="profile-card" role="main" aria-labelledby="profile-title">
        <header class="profile-header">
            <h2 id="profile-title">–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <p class="profile-subtitle">–î–∞–Ω–Ω—ã–µ –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞</p>
        </header>

        <div th:if="${errorMessage}" class="alert alert-error" role="alert" aria-live="assertive">
            <p th:text="${errorMessage}">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞</p>
        </div>
        <div th:if="${successMessage}" class="alert alert-success" role="status" aria-live="polite">
            <p th:text="${successMessage}">–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã</p>
        </div>

        <section aria-labelledby="profile-form-title">
            <h3 id="profile-form-title" class="sr-only">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h3>

            <form th:action="@{/user/profile}" th:object="${userDto}" method="post" novalidate
                  onsubmit="return validateProfile(this)">
                <div class="form-group">
                    <label for="username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input id="username" th:field="*{username}" type="text" required autocomplete="username"
                           aria-required="true" autofocus>
                </div>

                <div class="form-group">
                    <label for="password">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å <span class="input-hint">(–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)</span></label>
                    <div class="input-row" style="align-items:center">
                        <input id="password" th:field="*{password}" name="password" type="password" minlength="8"
                               placeholder="–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤" autocomplete="new-password">
                        <button type="button" class="btn btn-ghost" onclick="togglePassword('password')"
                                aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å –ø–∞—Ä–æ–ª—è">üëÅÔ∏è
                        </button>
                    </div>
                </div>

                <div class="form-actions" style="margin-top:1rem">
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                    <a th:href="@{ /static}" class="btn btn-ghost" style="margin-left:.5rem">–û—Ç–º–µ–Ω–∞</a>
                </div>
            </form>
        </section>

        <!-- –°–µ–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ API -->
        <section class="api-access" aria-labelledby="api-tokens-title" style="margin-top:2rem">
            <h3 id="api-tokens-title" class="small" style="color:var(--primary);">–î–æ—Å—Ç—É–ø –∫ API</h3>
            <p class="info-text">–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ API —Å–∏—Å—Ç–µ–º—ã</p>

            <div style="margin-top:1rem">
                <button type="button" class="btn btn-secondary" onclick="getAuthTokens()">–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω—ã</button>
            </div>

            <div id="tokens-result" style="display:none; margin-top:1rem">
                <div class="form-group">
                    <label for="access-token">Access Token</label>
                    <textarea id="access-token" rows="3" class="token-area" readonly></textarea>
                </div>
                <div class="form-group">
                    <label for="refresh-token">Refresh Token</label>
                    <textarea id="refresh-token" rows="3" class="token-area" readonly></textarea>
                </div>
                <button type="button" class="btn btn-ghost" onclick="copyTokens()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã</button>
            </div>
        </section>

        <section class="danger-zone" aria-labelledby="danger-title" style="margin-top:2rem">
            <h3 id="danger-title" class="small" style="color:var(--danger)">–û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h3>
            <p class="warning-text">–£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ–º—É —É–¥–∞–ª–µ–Ω–∏—é –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö.</p>
            <form th:action="@{/user/delete}" method="post" onsubmit="return confirmDeleteAccount(this)">
                <button type="submit" class="btn btn-danger" aria-label="–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç">
                    –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                </button>
            </form>
        </section>
    </main>
</div>

<script>
    function togglePassword(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.type = el.type === 'password' ? 'text' : 'password';
        el.focus();
    }

    function validateProfile(form) {
        const uname = (form.username.value || '').trim();
        const pwd = form.password ? form.password.value : '';
        if (uname.length < 1) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            form.username.focus();
            return false;
        }
        if (pwd && pwd.length > 0 && pwd.length < 8) {
            alert('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤');
            form.password.focus();
            return false;
        }
        return true;
    }

    function confirmDeleteAccount(form) {
        return confirm('–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.');
    }

    async function getAuthTokens() {
        try {
            const username = document.getElementById('username').value;
            const password = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤:');

            if (!password) return;

            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password })
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(error || '–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
            }

            const data = await response.json();

            document.getElementById('access-token').value = data.accessToken;
            document.getElementById('refresh-token').value = data.refreshToken;
            document.getElementById('tokens-result').style.display = 'block';

            alert('–¢–æ–∫–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã!');

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Ç–æ–∫–µ–Ω–∞:', error);
            alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤: ${error.message}`);
        }
    }

    function copyTokens() {
        const accessToken = document.getElementById('access-token').value;
        const refreshToken = document.getElementById('refresh-token').value;
        const text = `Access Token: ${accessToken}\nRefresh Token: ${refreshToken}`;

        navigator.clipboard.writeText(text)
            .then(() => {
                alert('–¢–æ–∫–µ–Ω—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤');
            });
    }
</script>
</body>
</html>